#!/bin/zsh

URL=$(osascript -e 'tell application "Google Chrome" to get URL of active tab of front window')

if [[ -z "$URL" || "$URL" != https://www.youtube.com/watch* ]]; then
  echo "‚ùå Not a valid YouTube video URL: $URL"
  exit 1
fi

echo "üé¨ Downloading from >> $URL"

FORMAT_INFO=$(yt-dlp -F "$URL")
BEST_HEIGHT=$(echo "$FORMAT_INFO" | grep -E '^[0-9]+.*video' | grep -Eo '[0-9]{3,4}x[0-9]{3,4}' | awk -Fx '{print $2}' | sort -nr | head -n1)

TITLE=$(yt-dlp --get-title "$URL" | tr -d '\n' | sed 's/[\/:*?"<>|]/_/g')

OUT_TPL="$HOME/Downloads/${TITLE}.%(ext)s"
TEMP_RAW_PATH="$HOME/Downloads/temp_raw_video"
FINAL_PATH="$HOME/Downloads/${TITLE}.mp4"

if [[ "$BEST_HEIGHT" -le 1080 ]]; then
  echo "üì• 1080p or lower detected. Downloading directly..."
  
  yt-dlp \
    -f "bestvideo[ext=mp4][vcodec*=avc]+bestaudio[ext=m4a]/best[ext=mp4]" \
    --merge-output-format mp4 \
    --no-warnings \
    --quiet \
    --progress \
    -o "$OUT_TPL" \
    "$URL"

  FINAL_PATH=$(ls -t ~/Downloads/*.mp4 | grep -i "$TITLE" | head -n 1)

else
  echo "üì• $BEST_HEIGHT detected. Downloading & re-encoding for QuickTime..."

  yt-dlp \
    -f "bv*+ba/b" \
    --merge-output-format mp4 \
    --no-warnings \
    --quiet \
    --progress \
    -o "$TEMP_RAW_PATH.%(ext)s" \
    "$URL"

  RAW_FILE=$(ls -t ~/Downloads/temp_raw_video.* | head -n 1)

  echo "üéûÔ∏è Re-encoding to H.264..."
  ffpb -i "$RAW_FILE" -c:v libx264 -c:a aac -movflags +faststart "$FINAL_PATH" -y < /dev/null

  rm "$RAW_FILE"
fi

echo "üìÇ Saved as $FINAL_PATH"
open -R "$FINAL_PATH"
